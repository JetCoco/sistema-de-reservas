<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inicio de sesión exitoso</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Bienvenido/a</h1>
    <p><strong>Email:</strong> <span id="email"></span></p>
    <p><strong>Access token:</strong> <span id="accessToken"></span></p>
    <p><strong>ID token:</strong> <span id="idToken"></span></p>
    <p><strong>Refresh token:</strong> <span id="refreshToken"></span></p>
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <script>
    function decodeJwt(token) {
      const payload = token.split('.')[1];
      const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
      return JSON.parse(decoded);
    }

    (function handleLoginRedirect() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const idToken = params.get('id_token');
      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');

      if (!idToken) {
        console.error('Token no encontrado en la URL.');
        window.location.href = "index.html";
        return;
      }

      try {
        // Guardar tokens en almacenamiento local
        localStorage.setItem("idToken", idToken);
        localStorage.setItem("accessToken", accessToken);
        localStorage.setItem("refreshToken", refreshToken);

        // Decodificar el token para extraer información
        const decoded = decodeJwt(idToken);
        const email = decoded.email || decoded["cognito:username"];
        const role = decoded["custom:role"];

        localStorage.setItem("email", email);
        localStorage.setItem("role", role);

        // Mostrar en pantalla (solo por debug o demo)
        document.getElementById("email").textContent = email;
        document.getElementById("accessToken").textContent = accessToken;
        document.getElementById("idToken").textContent = idToken;
        document.getElementById("refreshToken").textContent = refreshToken;

        // Redirección según el rol
        if (role === "admin") {
          window.location.href = "admin.html";
        } else if (role === "instructor") {
          window.location.href = "instructor.html";
        } else {
          window.location.href = "index.html";
        }

      } catch (err) {
        console.error("Error al procesar el token:", err);
        window.location.href = "index.html";
      }
    })();

    function logout() {
      localStorage.clear();
      sessionStorage.clear();
      const domain = 'https://us-east-1peioypcf6.auth.us-east-1.amazoncognito.com';
      const clientId = '1a43cn452jearoj6siqsnj70g5';
      const logoutRedirect = 'https://sistema-reservas-frontend.s3.us-east-1.amazonaws.com/index.html';
      const logoutUrl = `${domain}/logout?client_id=${clientId}&logout_uri=${encodeURIComponent(logoutRedirect)}`;
      window.location.href = logoutUrl;
    }
  </script>
</body>
</html>